version: 2

models:
  - name: account_subscription_details
    description: >
      Aggregates subscription details and history at the account level.
      Provides subscription counts, date ranges, latest subscription details, and upgrade/downgrade
      history for each customer account.
    
    columns:
      - name: account_id
        description: "Unique identifier for each customer account"
        tests:
          - not_null
          - unique
      
      - name: total_subscriptions
        description: "Total number of subscriptions the account has had"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      
      - name: first_subscription_date
        description: "Date of the account's first subscription"
        tests:
          - not_null
      
      - name: last_subscription_date
        description: "Date of the account's most recent subscription"
        tests:
          - not_null
      
      - name: latest_plan_tier
        description: "Most recent plan tier (Basic, Pro, Enterprise)"
        tests:
          - accepted_values:
              values: ['Basic', 'Pro', 'Enterprise']
      
      - name: latest_seats
        description: "Number of seats in the most recent subscription"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 10000
      
      - name: upgrade_count
        description: "Number of times the account has upgraded"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      
      - name: downgrade_count
        description: "Number of times the account has downgraded"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
    
    tests:
      - dbt_utils.expression_is_true:
          expression: "first_subscription_date <= last_subscription_date"
          config:
            severity: error
      
      - dbt_utils.expression_is_true:
          expression: "total_subscriptions >= 1"
          config:
            severity: error

  - name: retention_metrics
    description: >
      Feature popularity and stickiness analysis comparing retained vs churned customers. 
      Contains feature usage metrics, popularity scores, and stickiness calculations 
      to identify features that drive retention. Granularity: one row per customer_status 
      per feature_name. Core dimensions: customer_status, feature_name, is_beta_feature. 
      Core metrics: popularity_score, stickiness_score, penetration_rate.
    columns:
      - name: retention_metrics_key
        description: "Surrogate key combining customer_status and feature_name for uniqueness"
        tests:
          - not_null
          - unique
      - name: customer_status
        description: "Customer retention status: retained or churned"
      - name: feature_name
        description: "Product feature name for analysis"
        tests:
          - not_null
      - name: is_beta_feature
        description: "Boolean flag indicating feature is in beta testing phase"
      - name: users_count
        description: "Number of unique accounts using this feature"
      - name: penetration_pct
        description: "Percentage of customers in status segment using this feature"
      - name: total_usage_events
        description: "Total number of usage events for this feature"
      - name: total_usage_minutes
        description: "Total usage duration in minutes across all users"
      - name: avg_months_with_usage
        description: "Average number of months per user with feature usage activity"
      - name: popularity_score
        description: "Weighted popularity score 0-1 combining penetration, usage intensity, duration engagement, and frequency consistency"
      - name: stickiness_score
        description: "Feature stickiness score combining adoption gap (40%), usage intensity gap (30%), and retention rate (30%)"
      - name: adoption_gap
        description: "Difference in penetration rate between retained and churned customers"
      - name: usage_intensity_gap
        description: "Difference in average usage minutes between retained and churned customers"
      - name: retention_rate
        description: "Percentage of feature users who are retained (not churned)"

  - name: monthly_recurring_revenue
    description: >
      Monthly MRR rollup with growth metrics and cohort analysis. Aggregates subscription 
      revenue data with month-over-month comparisons and growth calculations. 
      Granularity: one row per month. Core metrics: total_mrr, new_mrr, churned_mrr, 
      mrr_growth_rate_pct, net_new_mrr.
    columns:
      - name: month_start
        description: "First day of the month for time series analysis"
      - name: total_mrr
        description: "Total monthly recurring revenue for the month in USD"
      - name: new_mrr
        description: "MRR from new subscriptions starting in this month, excluding trials"
      - name: churned_mrr
        description: "MRR lost from subscriptions ending in this month"
      - name: total_subscriptions
        description: "Total number of active subscriptions during the month"
      - name: new_subscriptions
        description: "Number of new subscriptions starting in this month"
      - name: churned_subscriptions
        description: "Number of subscriptions ending in this month"
      - name: total_accounts
        description: "Total number of unique accounts with active subscriptions"
      - name: trial_mrr
        description: "MRR attributed to trial subscriptions"
      - name: paid_mrr
        description: "MRR attributed to paid (non-trial) subscriptions"
      - name: trial_count
        description: "Number of trial subscriptions"
      - name: paid_count
        description: "Number of paid (non-trial) subscriptions"
      - name: prior_month_mrr
        description: "Total MRR from the previous month for growth calculations"
      - name: mrr_change
        description: "Absolute change in MRR from previous month in USD"
      - name: mrr_growth_rate_pct
        description: "Month-over-month MRR growth rate as percentage"
      - name: net_new_mrr
        description: "New MRR minus churned MRR, showing net MRR movement"
      - name: avg_mrr_per_account
        description: "Average MRR per account, calculated as total_mrr / total_accounts"
      - name: avg_mrr_per_paid_subscription
        description: "Average MRR per paid subscription, excluding trials"

  - name: monthly_active_accounts
    description: >
      Monthly active account metrics with plan tier segmentation and growth analysis. 
      Tracks account counts and changes over time by subscription tier. 
      Granularity: one row per month. Core dimensions: month_start. 
      Core metrics: accounts_at_start, accounts_change_from_previous_month by tier.
    columns:
      - name: month_start
        description: "First day of the month for time series analysis"
      - name: accounts_at_start
        description: "Total number of active paid accounts at month start"
      - name: subscriptions_at_start
        description: "Total number of active paid subscriptions at month start"
      - name: enterprise_at_start
        description: "Number of Enterprise tier accounts at month start"
      - name: pro_at_start
        description: "Number of Pro tier accounts at month start"
      - name: basic_at_start
        description: "Number of Basic tier accounts at month start"
      - name: accounts_change_from_previous_month
        description: "Net change in total active accounts from previous month"

  - name: conversion_metrics
    description: >
      Trial-to-paid and tier upgrade conversion analysis by referral source and overall. 
      Contains conversion rates, upgrade patterns, and source attribution metrics. 
      Granularity: one row per month per referral source plus overall aggregated metrics. 
      Core dimensions: month_start, overall_or_referral_source. Core metrics: 
      trial_to_paid_conversion_rate, lower_to_higher_tier_conversion_rate.
    columns:
      - name: month_start
        description: "First day of the month for time series analysis"
      - name: overall_or_referral_source
        description: "Either 'Overall' for aggregated metrics or specific referral source name"
      - name: trial_starts
        description: "Number of accounts that started trials in this month"
      - name: trial_conversions
        description: "Number of trial accounts that converted to paid subscriptions"
      - name: trial_to_paid_conversion_rate
        description: "Conversion rate from trial to paid subscription, calculated as trial_conversions / trial_starts"
      - name: basic_tier_accounts
        description: "Number of accounts on Basic tier available for upgrade"
      - name: pro_tier_accounts
        description: "Number of accounts on Pro tier available for upgrade"
      - name: basic_to_higher_upgrades
        description: "Number of accounts that upgraded from Basic to Pro or Enterprise"
      - name: pro_to_enterprise_upgrades
        description: "Number of accounts that upgraded from Pro to Enterprise"
      - name: total_tier_upgrades
        description: "Total number of tier upgrades (Basic→Pro/Enterprise + Pro→Enterprise)"
      - name: lower_to_higher_tier_conversion_rate
        description: "Upgrade conversion rate from lower tiers to higher tiers"

  - name: mrr_by_segments
    description: >
      MRR analysis segmented by customer industry and subscription plan tiers. 
      Union of industry-based and plan-based MRR breakdowns with comparative metrics. 
      Granularity: one row per month per segment (industry or plan). 
      Core dimensions: segment_type, segment_value, month_start. 
      Core metrics: mrr, account_count, avg_mrr_per_subscription, market_share_pct.
    columns:
      - name: segment_type
        description: "Type of segmentation: 'Customer Industry' or 'Subscription Plan'"
      - name: segment_value
        description: "Specific segment value (industry name or plan tier)"
      - name: month_start
        description: "First day of the month for time series analysis"
      - name: mrr
        description: "Total MRR for this segment in USD"
      - name: subscription_count
        description: "Number of subscriptions in this segment"
      - name: account_count
        description: "Number of unique accounts in this segment"
      - name: avg_mrr_per_subscription
        description: "Average MRR per subscription within segment"
      - name: enterprise_count
        description: "Number of Enterprise tier subscriptions in segment"
      - name: pro_count
        description: "Number of Pro tier subscriptions in segment"
      - name: basic_count
        description: "Number of Basic tier subscriptions in segment"
      - name: market_share_pct
        description: "Segment's percentage share of total MRR for the month"
      - name: rank_by_mrr
        description: "Segment's rank by MRR within segment_type for the month"
