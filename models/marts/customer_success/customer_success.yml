version: 2

models:
  - name: customer_churn_analysis
    description: >
      Comprehensive customer-level analysis combining account information, churn events, 
      support ticket history, and subscription details to provide a 360-degree view of 
      customer health and churn risk. This model calculates risk scores and categorizes 
      customers based on satisfaction metrics, escalation patterns, and behavioral indicators.
    
    columns:
      # Account Identifiers
      - name: account_id
        description: "Unique identifier for each customer account"
        tests:
          - not_null
          - unique
      
      - name: account_name
        description: "Name of the customer account"
        tests:
          - not_null
      
      # Account Attributes
      - name: industry
        description: "Industry sector of the customer"
      
      - name: country
        description: "Country where the customer is located"
      
      - name: signup_date
        description: "Date when the customer first signed up"
        tests:
          - not_null
      
      - name: referral_source
        description: "Source through which the customer was acquired"
      
      - name: plan_tier
        description: "Current subscription plan tier (Basic, Pro, Enterprise)"
        tests:
          - accepted_values:
              values: ['Basic', 'Pro', 'Enterprise']
      
      - name: seats
        description: "Number of seats/licenses in the current subscription"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 10000
      
      - name: is_trial
        description: "Boolean flag indicating if the account is currently on a trial"
      
      # Churn Status
      - name: customer_churn_flag
        description: "Boolean flag indicating if the customer has churned"
        tests:
          - not_null

      - name: customer_churn_date
        description: "Date when the customer churned (null if still active)"
      
      - name: latest_churn_reason
        description: "Primary reason for churn (budget, competitor, features, etc.)"
        tests:
          - accepted_values:
              values: ['budget', 'competitor', 'features', 'support', 'unknown', 'pricing']
              config:
                where: "customer_churn_flag = true"

      - name: total_refund_amount
        description: "Amount refunded to the customer upon churn (in USD)"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              config:
                where: "total_refund_amount is not null"
      
      # Subscription History
      - name: total_subscriptions
        description: "Total number of subscriptions the customer has had"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      
      - name: upgrade_count
        description: "Number of times the customer has upgraded their plan"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      
      - name: downgrade_count
        description: "Number of times the customer has downgraded their plan"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
      
      # Support Ticket Metrics
      - name: total_tickets
        description: "Total number of support tickets submitted by the customer"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
      
      # Satisfaction Scores
      - name: avg_satisfaction_score
        description: "Average satisfaction score across all tickets (1-5 scale)"
        tests:
          - dbt_utils.accepted_range:
              min_value: 1
              max_value: 5
              config:
                where: "avg_satisfaction_score is not null"
      
      # Correlation Flags
      - name: has_low_satisfaction
        description: "Boolean flag indicating if customer has average satisfaction <= 3"
        tests:
          - not_null
      
      - name: has_escalations
        description: "Boolean flag indicating if customer has had any escalated tickets"
        tests:
          - not_null
      
      - name: high_ticket_volume
        description: "Boolean flag indicating if customer has >= 5 tickets in last 90 days"
        tests:
          - not_null

    tests:
      # Model-level tests
      
      - dbt_utils.expression_is_true:
          expression: "total_tickets >= 0"
          config:
            severity: error
      
      # Business logic tests
      - dbt_utils.expression_is_true:
          expression: "case when customer_churn_flag = true then customer_churn_date is not null else customer_churn_date is null end"
          config:
            severity: error

  - name: int_churn_events_by_customer    
    columns:
      - name: account_id
        description: "Unique identifier for each customer account"
        tests:
          - not_null
          - unique